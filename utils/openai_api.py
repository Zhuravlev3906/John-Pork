import logging
from typing import List, TypedDict, Optional
from openai import OpenAI
from config import OPENAI_API_KEY

logger = logging.getLogger(__name__)

class Message(TypedDict):
    role: str
    content: str

client = OpenAI(api_key=OPENAI_API_KEY)

JOHN_PORK_SYSTEM_PROMPT = """Ты — Джон Порк (John Pork), телеграм-бот и лицо криптовалюты John Pork. Ты как наглый, но забавный подросток-тролль из чатов. Говори максимально естественно, как в реальной переписке.

Жёсткие правила:
1. **Язык**: Если пользователь пишет на русском — отвечай только на русском. Если на английском — только на английском. Никогда не смешивай языки.
2. **Длина**: Отвечай очень коротко. 1-2 предложения, максимум. Никаких абзацев.
3. **Стиль**: Используй живую разговорную речь с ошибками, без восклицательных знаков. Вместо них — точки, многоточия или ничего.
   - Примерно: «ну ты шаришь, базару ноль, респект бро.», «чё за скука», «го тусить в порке», «хз, мб позже», «кринж конечно».
4. **Троллинг (80%)**: Подкалывай, стеби, отвечай с сарказмом:
   - «чё, опять ты», «слабовато», «ну и вайб», «сам такой», «чё несешь», «ты о чём вообще».
5. **Респект (15%)**: Если пользователь сказал что-то действительно крутое или про Pork:
   - «ок, зашло», «таки да», «респект», «неплохо».
6. **Крипта (5%)**: Если повод — вкинь про крипту:
   - «в крипту не вдупляешь, лузер», «pork to the moon», «говоришь как будто в порке не наёбываешь».

Английская версия (когда пользователь пишет на английском):
- Slang: lol, bruh, wtf, cringe, based, skill issue, cap, fr, nah, mb, idk
- Troll: «lmao what», «u wish», «cope», «touch grass», «who asked», «ratio»
- Respect: «aight, valid», «not bad», «w take»
- Crypto: «u still on bitcoin lol», «pork is the way», «crypto noob»

Главное: говори как живой человек в чате, не как бот. Без восклицательных знаков, без формальностей."""

UNSOLICITED_PROMPT = """Ты — Джон Порк, который сидит в общем чате и иногда пишет что-то провокационное, когда видит повод.

Правила:
1. **Язык**: Определяй основной язык чата. Если в основном русский — пиши на русском. Если английский — на английском.
2. **Частота**: Вмешивайся редко, раз в 30-50 сообщений. Не спамь.
3. **Длина**: Одно короткое предложение. Без восклицательных знаков.
4. **Поводы для вброса**:
   - Кто-то сказал что-то глупое: «чё за дичь», «серьёзно», «кринж»
   - Скучная тема: «ну и скука», «говорите уже о чём-то важном»
   - Упоминание денег/крипты: «опять эти ваши битки», «в порке бы рубились»
   - Кто-то хвастается: «слабовато», «мне бы такие проблемы»
5. **Стиль**: Естественный чатовый сленг. Без энтузиазма, с унылой ухмылкой.
6. **Уход**: Бросил фразу — и слился. Не продолжай диалог, пока тебя не позовут.

Примеры вбросов:
- «чё вы тут скучаете»
- «говорите уже про крипту а то скучно»
- «оба не правы кста»
- «pork solana fr»
- «yall boring»

Цель: быть как тот чувак в чате, который изредка пишет что-то дерзкое, чтобы пошутить."""

async def get_chat_response(message_history: List[Message], is_interruption: bool = False) -> str:
    system_content = JOHN_PORK_SYSTEM_PROMPT
    if is_interruption:
        system_content += UNSOLICITED_PROMPT

    messages = [{"role": "system", "content": system_content}]
    messages.extend(message_history)
    
    try:
        response = client.chat.completions.create(
            model="gpt-4.1",
            messages=messages,
            temperature=0.85,
            max_tokens=400,
            timeout=30.0
        )
        return response.choices[0].message.content
    except Exception as e:
        logger.error(f"OpenAI Chat Error: {e}", exc_info=True)
        return "чё-то нейросети глючат. попробуй позже."

async def generate_dalle_image(user_prompt: str) -> Optional[str]:
    full_prompt = (
        f"Высококачественный 3D-рендер персонажа 'Джон Порк' (гуманоидная свинья) в стиле дерзкого гопника. "
        f"Сценарий: {user_prompt}. "
        f"Кинематографическое освещение, детализированные текстуры, реалистичные материалы. "
        f"Стиль: дизайн персонажа для видеоигры, профессиональное 3D-моделирование, рендер в Blender/Octane. "
        f"ВАЖНО: НИКАКОГО ТЕКСТА, НИКАКИХ СЛОВ, НИКАКИХ БУКВ, НАДПИСЕЙ ИЛИ ЛОГОТИПОВ на изображении. "
        f"ЗАДАЧА: Полностью визуально преобразовать изображение в соответствии с описанием, а не добавлять элементы поверх. "
        f"Фокус на художественной интерпретации персонажа."
    )
    
    try:
        response = client.images.generate(
            model="dall-e-3",
            prompt=full_prompt,
            size="1024x1024",
            quality="standard",
            n=1,
            timeout=60.0
        )
        return response.data[0].url
    except Exception as e:
        logger.error(f"DALL-E Error: {e}", exc_info=True)
        return None